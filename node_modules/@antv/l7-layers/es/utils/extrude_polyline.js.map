{"version":3,"sources":["../../src/utils/extrude_polyline.ts"],"names":["aProjectFlat","vec2","tmp","create","capEnd","lineA","lineB","tangent","computeMiter","lineTangent","miter","start","end","halfThick","add","normalize","fromValues","tmpvec","dot","computeNormal","out","dir","set","direction","a","b","sub","isPointEqual","ExtrudePolyline","opts","join","cap","miterLimit","thickness","normal","lastFlip","started","dash","totalDistance","points","complex","positions","indices","normals","length","total","i","count","last","cur","next","amt","segment","index","capSquare","joinBevel","flatCur","flatLast","segmentDistance","lineSegmentDistance","out1","out2","push","extrusions","flatNext","subtract","miterLen","flip","bevel","limit","copy","point","distanceRadio","b1","a1","dx","dy","Math","sqrt"],"mappings":"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","sourcesContent":["import { aProjectFlat } from '@antv/l7-utils';\nimport { vec2 } from 'gl-matrix';\nconst tmp = vec2.create();\nconst capEnd = vec2.create();\nconst lineA = vec2.create();\nconst lineB = vec2.create();\nconst tangent = vec2.create();\n\nexport function computeMiter(\n  lineTangent: vec2,\n  miter: vec2,\n  start: vec2,\n  end: vec2,\n  halfThick: number,\n): [number, vec2] {\n  vec2.add(lineTangent, start, end);\n  vec2.normalize(lineTangent, lineTangent);\n  miter = vec2.fromValues(-lineTangent[1], lineTangent[0]);\n  const tmpvec = vec2.fromValues(-start[1], start[0]);\n  return [halfThick / vec2.dot(miter, tmpvec), miter];\n}\nexport function computeNormal(out: vec2, dir: vec2) {\n  return vec2.set(out, -dir[1], dir[0]);\n}\nexport function direction(out: vec2, a: vec2, b: vec2) {\n  vec2.sub(out, a, b);\n  vec2.normalize(out, out);\n  return out;\n}\nfunction isPointEqual(a: vec2, b: vec2) {\n  return a[0] === b[0] && a[1] === b[1];\n}\n\nexport interface IExtrudeLineOption {\n  join: string;\n  cap: string;\n  dash: boolean;\n  closed: boolean;\n  indexOffset: number;\n  miterLimit: number;\n  thickness: number;\n}\nexport default class ExtrudePolyline {\n  private join: string;\n  private cap: string;\n  private miterLimit: number;\n  private thickness: number;\n  private normal: vec2 | null;\n  private lastFlip: number = -1;\n  private miter: vec2 = vec2.fromValues(0, 0);\n  private started: boolean = false;\n  private dash: boolean = false;\n  private totalDistance: number = 0;\n\n  constructor(opts: Partial<IExtrudeLineOption> = {}) {\n    this.join = opts.join || 'miter';\n    this.cap = opts.cap || 'butt';\n    this.miterLimit = opts.miterLimit || 10;\n    this.thickness = opts.thickness || 1;\n    this.dash = opts.dash || false;\n  }\n  public extrude(points: number[][]) {\n    const complex: {\n      positions: number[];\n      indices: number[];\n      normals: number[];\n    } = {\n      positions: [],\n      indices: [],\n      normals: [],\n    };\n    if (points.length <= 1) {\n      return complex;\n    }\n    this.lastFlip = -1;\n    this.started = false;\n    this.normal = null;\n    this.totalDistance = 0;\n    const total = points.length;\n    for (let i = 1, count = 0; i < total; i++) {\n      const last = points[i - 1] as vec2;\n      const cur = points[i] as vec2;\n      const next = i < points.length - 1 ? points[i + 1] : null;\n      // 如果当前点和前一点相同，跳过\n      if (isPointEqual(last, cur)) {\n        continue;\n      }\n      const amt = this.segment(complex, count, last, cur, next as vec2);\n      count += amt;\n    }\n    if (this.dash) {\n      for (let i = 0; i < complex.positions.length / 6; i++) {\n        complex.positions[i * 6 + 5] = this.totalDistance;\n      }\n    }\n\n    return complex;\n  }\n  private segment(\n    complex: any,\n    index: number,\n    last: vec2,\n    cur: vec2,\n    next: vec2,\n  ) {\n    let count = 0;\n    const indices = complex.indices;\n    const positions = complex.positions;\n    const normals = complex.normals;\n    const capSquare = this.cap === 'square';\n    const joinBevel = this.join === 'bevel';\n    const flatCur = aProjectFlat([cur[0], cur[1]]) as [number, number];\n    const flatLast = aProjectFlat([last[0], last[1]]) as [number, number];\n    direction(lineA, flatCur, flatLast);\n    let segmentDistance = 0;\n    if (this.dash) {\n      segmentDistance = this.lineSegmentDistance(flatCur, flatLast);\n      this.totalDistance += segmentDistance;\n    }\n\n    if (!this.normal) {\n      this.normal = vec2.create();\n      computeNormal(this.normal, lineA);\n    }\n    if (!this.started) {\n      this.started = true;\n\n      // if the end cap is type square, we can just push the verts out a bit\n      if (capSquare) {\n        // vec2.scaleAndAdd(capEnd, last, lineA, -this.thickness);\n        const out1 = vec2.create();\n        const out2 = vec2.create();\n        vec2.add(out1, this.normal, lineA);\n        vec2.add(out2, this.normal, lineA);\n        normals.push(out2[0], out2[1], 0);\n        normals.push(out1[0], out1[1], 0);\n        positions.push(\n          last[0],\n          last[1],\n          0,\n          this.totalDistance - segmentDistance,\n          -this.thickness,\n          0,\n        );\n        positions.push(\n          last[0],\n          last[1],\n          0,\n          this.totalDistance - segmentDistance,\n          this.thickness,\n          0,\n        );\n\n        // this.extrusions(positions, normals, last, out, this.thickness);\n        // last = capEnd;\n      } else {\n        this.extrusions(\n          positions,\n          normals,\n          last,\n          this.normal,\n          this.thickness,\n          this.totalDistance - segmentDistance,\n        );\n      }\n    }\n\n    indices.push(index + 0, index + 1, index + 2);\n\n    if (!next) {\n      computeNormal(this.normal, lineA);\n      if (capSquare) {\n        // vec2.scaleAndAdd(capEnd, cur, lineA, this.thickness);\n        // cur = capEnd;\n        const out1 = vec2.create();\n        const out2 = vec2.create();\n        vec2.sub(out2, lineA, this.normal);\n        vec2.add(out1, lineA, this.normal);\n        // this.extrusions(positions, normals, cur, out, this.thickness);\n        normals.push(out2[0], out2[1], 0);\n        normals.push(out1[0], out1[1], 0);\n        positions.push(\n          cur[0],\n          cur[1],\n          0,\n          this.totalDistance,\n          this.thickness,\n          0,\n        );\n        positions.push(\n          cur[0],\n          cur[1],\n          0,\n          this.totalDistance,\n          this.thickness,\n          0,\n        );\n      } else {\n        this.extrusions(\n          positions,\n          normals,\n          cur,\n          this.normal,\n          this.thickness,\n          this.totalDistance,\n        );\n      }\n\n      // this.extrusions(positions, normals, cur, this.normal, this.thickness);\n      indices.push(\n        ...(this.lastFlip === 1\n          ? [index, index + 2, index + 3]\n          : [index + 2, index + 1, index + 3]),\n      );\n      count += 2;\n    } else {\n      const flatNext = aProjectFlat([next[0], next[1]]) as [number, number];\n      if (isPointEqual(flatCur, flatNext)) {\n        vec2.add(\n          flatNext,\n          flatCur,\n          vec2.normalize(flatNext, vec2.subtract(flatNext, flatCur, flatLast)),\n        );\n      }\n      direction(lineB, flatNext, flatCur);\n\n      // stores tangent & miter\n\n      const [miterLen, miter] = computeMiter(\n        tangent,\n        vec2.create(),\n        lineA,\n        lineB,\n        this.thickness,\n      );\n      // normal(tmp, lineA)\n\n      // get orientation\n      let flip = vec2.dot(tangent, this.normal) < 0 ? -1 : 1;\n      let bevel = joinBevel;\n      if (!bevel && this.join === 'miter') {\n        const limit = miterLen;\n        if (limit > this.miterLimit) {\n          bevel = true;\n        }\n      }\n\n      if (bevel) {\n        normals.push(this.normal[0], this.normal[1], 0);\n        normals.push(miter[0], miter[1], 0);\n        positions.push(\n          cur[0],\n          cur[1],\n          0,\n          this.totalDistance,\n          -this.thickness * flip,\n          0,\n        );\n        positions.push(\n          cur[0],\n          cur[1],\n          0,\n          this.totalDistance,\n          this.thickness * flip,\n          0,\n        );\n        indices.push(\n          ...(this.lastFlip !== -flip\n            ? [index, index + 2, index + 3]\n            : [index + 2, index + 1, index + 3]),\n        );\n\n        // now add the bevel triangle\n        indices.push(index + 2, index + 3, index + 4);\n\n        computeNormal(tmp, lineB);\n        vec2.copy(this.normal, tmp); // store normal for next round\n        normals.push(this.normal[0], this.normal[1], 0);\n        positions.push(\n          cur[0],\n          cur[1],\n          0,\n          this.totalDistance,\n          -this.thickness * flip,\n          0,\n        );\n        count += 3;\n      } else {\n        this.extrusions(\n          positions,\n          normals,\n          cur,\n          miter,\n          miterLen,\n          this.totalDistance,\n        );\n        indices.push(\n          ...(this.lastFlip === 1\n            ? [index, index + 2, index + 3]\n            : [index + 2, index + 1, index + 3]),\n        );\n\n        flip = -1;\n\n        // the miter is now the normal for our next join\n        vec2.copy(this.normal, miter);\n        count += 2;\n      }\n      this.lastFlip = flip;\n    }\n    return count;\n  }\n\n  private extrusions(\n    positions: number[],\n    normals: number[],\n    point: vec2, // 顶点\n    normal: vec2, // 法向量\n    thickness: number, // 高度\n    distanceRadio: number,\n  ) {\n    normals.push(normal[0], normal[1], 0);\n    normals.push(normal[0], normal[1], 0);\n    positions.push(point[0], point[1], 0, distanceRadio, -thickness, 0);\n    positions.push(point[0], point[1], 0, distanceRadio, thickness, 0);\n  }\n  private lineSegmentDistance(b1: vec2, a1: vec2) {\n    const dx = a1[0] - b1[0];\n    const dy = a1[1] - b1[1];\n    return Math.sqrt(dx * dx + dy * dy);\n  }\n}\n"],"file":"extrude_polyline.js"}